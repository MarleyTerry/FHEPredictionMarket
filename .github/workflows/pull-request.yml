name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: PR Details
        run: |
          echo "## Pull Request Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Branch**: ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY

  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run prettier:check

      - name: Lint Solidity
        run: npm run lint:sol

      - name: Quick compile
        run: npm run compile

  test-changes:
    name: Test Changed Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all tests
        run: npm test

      - name: Comment test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ job.status }}';
            const body = testResult === 'success'
              ? 'âœ… All tests passed successfully!'
              : 'âŒ Some tests failed. Please check the logs.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage
        run: npm run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: pr-${{ github.event.pull_request.number }}
          fail_ci_if_error: false

      - name: Comment coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let coverageComment = '## Code Coverage Report\n\n';

            try {
              if (fs.existsSync('coverage/coverage-summary.json')) {
                const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                const total = summary.total;

                coverageComment += '| Metric | Coverage |\n';
                coverageComment += '|--------|----------|\n';
                coverageComment += `| Lines | ${total.lines.pct}% |\n`;
                coverageComment += `| Statements | ${total.statements.pct}% |\n`;
                coverageComment += `| Functions | ${total.functions.pct}% |\n`;
                coverageComment += `| Branches | ${total.branches.pct}% |\n`;
              } else {
                coverageComment += 'Coverage report not available.';
              }
            } catch (error) {
              coverageComment += 'Error reading coverage report.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageComment
            });

  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Comment security status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const body = 'ðŸ”’ Security audit completed. Check the workflow logs for details.';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  size-check:
    name: Contract Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile and check size
        run: |
          npm run compile
          echo "## Contract Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Contracts compiled successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For detailed size information, check artifacts folder" >> $GITHUB_STEP_SUMMARY

  approval-requirements:
    name: Check Approval Requirements
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main'

    steps:
      - name: Check if ready for merge
        run: |
          echo "## Merge Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] All tests passing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Code review approved" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No merge conflicts" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] CI/CD checks passing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Documentation updated (if needed)" >> $GITHUB_STEP_SUMMARY

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [quick-checks, test-changes, coverage-report, security-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Pull Request CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Quick Checks: ${{ needs.quick-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Changes: ${{ needs.test-changes.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Report: ${{ needs.coverage-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Check: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quick-checks.result }}" == "success" ] && \
             [ "${{ needs.test-changes.result }}" == "success" ]; then
            echo "âœ… **All checks passed! PR is ready for review.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed. Please review and fix issues.**" >> $GITHUB_STEP_SUMMARY
          fi
